\subsubsection{Messages}
\begin{lstlisting}[language=sql]
/* function storeConversation($id) */
insert into conversations (usera, userb)
value (?, ?),
[min(\Auth::id(), $userId), max(\Auth::id(), $userId)];

/* function loadConversation($id) */
select   *
from     conversations
where    usera = ? and userb = ?,
[min(\Auth::id(), $id), max(\Auth::id(), $id)];

/* function loadLatestConversation() */
select   c.usera, c.userb
from     conversations c
join     messages m on c.id = m.conversationid
where    c.usera = ? or c.userb = ?
order by date desc
limit    1,
[\Auth::id(), \Auth::id()];

/* function storeMessage($cId, $message) */
insert into messages (conversationid, author, message)
value (?, ?, ?),
[$cId, \Auth::id(), $message];

/* function loadAllMessagesInDB() */
select   c.usera, c.userb, m.message, m.date, u.username
from     conversations c
join     messages m on c.id = m.conversationid
join     users u on m.author = u.id
order by date;


/* function loadAllMessages($id) */
select   u.username,m.message,m.date
from     conversations c
join     messages m on c.id = m.conversationid
join     users u on u.id = m.author
where    c.usera = ? and c.userb = ?,
[min(\Auth::id(), $id2), max(\Auth::id(), $id2)];

/* function loadConversationsWithMessage() */
/* //Get all conversations for the logged in user, then only select the latest message for each of them */
select   usera, userb, message, date
from     (select c.id, c.usera, c.userb, m.message, m.date
    from    conversations c
    join    messages m on c.id = m.conversationid
    join    users u on u.id = m.author
    where   c.usera = ? or c.userb = ?
    order by date desc) as x
group by id
order by date desc,
[\Auth::id(), \Auth::id()];

/* function loadLastNConversationsWithMessage($n) */
/* //Get all conversations for the logged in user, then only select the latest message for each of them */
select   *
from     (select    case when c.usera = ? then c.userb else c.usera end as otheruser, image, message, is_read, author, date
    from       conversations c
    join       messages m on c.id = m.conversationid
    join       users u on u.id = m.author
    where      c.usera = ? or c.userb = ?
    order by   m.id desc) as x
group by otheruser
limit    ?,
[\Auth::id(), \Auth::id(), \Auth::id(), $n];

/* function loadUnreadMessages() */
select  *
from    conversations c
join    messages m on c.id = m.conversationid
where   m.author <> ? and m.is_read = 0 and (c.usera = ? or c.userb = ?),
[\Auth::id(), \Auth::id(), \Auth::id()];

//get the last message that was user $id has read
/* function loadLastReadMessage($id) */
select   *
from     conversations c
join     messages m on c.id = m.conversationid
where    m.is_read = 1 and c.usera = ? and c.userb = ? and m.author = ?
order by m.id desc,
[$a, $b, \Auth::id()];

/* function loadLastNMessages($n) */
select   *
from     conversations c
join     messages m on c.id = m.conversationid
where    c.usera = ? or c.userb = ?
order by m.id desc
limit    ?,
[\Auth::id(), \Auth::id(), $n];

/* function UpdateMessagesToSeen($id) */
update   messages m
join     (select *
        from    conversations c
        where   c.usera = ? and c.userb = ?) cc
on       cc.id = m.conversationid
set      m.is_read = true
where    m.author <> ?,
[$a, $b, \Auth::id()];

\end{lstlisting}
